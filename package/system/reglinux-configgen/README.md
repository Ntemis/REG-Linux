# üéÆ `emulatorlauncher.py` Overview

This script is the main **game and emulator launcher** for a retro-gaming environment (such as Batocera, Recalbox, or similar). It's highly modular and robust, with support for video modes, controllers, HUDs, netplay, lightguns, wheels, and even `.squashfs` ROM formats.

---

## üîß 1. Initialization & Optional Profiling

If `/var/run/emulatorlauncher.perf` exists, it enables `cProfile` profiling for performance diagnostics. Profiling data is saved for analysis with tools like `gprof2dot` or `pstats-viewer`.

---

## üß© 2. SquashFS Support

Two main functions handle `.squashfs` files:

- `squashfs_begin(rom)`: Mounts the compressed ROM to `/var/run/squashfs/<rom_name>`.
- `squashfs_end(mountpoint)`: Unmounts and cleans the temporary directory.

---

## üïπ 3. `main()` Function

- Detects if the ROM is a `.squashfs` file.
- Calls `start_rom()` with either the mounted path or the original ROM path.
- Ensures cleanup even on failure.

---

## üïπ 4. `start_rom()` Function ‚Äì Core Execution Flow

This is the **core logic** of the launcher. It performs:

1. **Controller Configuration**: Supports up to 8 players using CLI arguments.
2. **Emulator Setup**: Initializes an `Emulator` instance with optional forced core/emulator.
3. **Metadata Loading**: Reads metadata about the game.
4. **Peripheral Setup**:
   - **Lightguns**: Uses `gunsUtils` for calibration.
   - **Wheels**: Uses `wheelsUtils` for reconfiguration.
5. **Video Mode Handling**:
   - Changes resolution if necessary.
   - Restores it later if modified.
6. **Save Directory Handling**
7. **Netplay Setup**: Handles host/client, IP, port, password, and session.
8. **Autosave/State Slot Handling**
9. **Mouse Visibility Configuration**
10. **Pre-execution Scripts**: Executes scripts in:
    - `/usr/share/reglinux/configgen/scripts`
    - `/userdata/system/scripts`
11. **Compositor Handling**: Starts Wayland/X11 if required.
12. **Emulator Execution**:
    - Uses `Evmapy` for input mapping.
    - Builds command with `Generator.generate(...)`.
    - Optionally inserts `mangohud` for HUD overlays.
    - Executes with `runCommand()`.
13. **Post Execution Cleanup**:
    - Stops `Evmapy`, compositor, and peripherals.
    - Runs post-game scripts.

---

## üì∫ 5. `getHudBezel()` Function

Decides whether a HUD overlay with a bezel should be used. Handles:

- Transparent bezels
- Image overlays
- Gun borders
- Aspect ratio validation
- Dynamic resizing or tattooing of the bezel

---

## üßæ 6. `getHudConfig()` Function

Generates HUD configuration (saved to `/var/run/hud.config`) using:

- Mode (`perf`, `game`, `custom`)
- System/emulator/game name
- Thumbnail image
- Custom positioning
- Background alpha and layout

---

## üèÉ 7. `runCommand()` Function

Runs the command generated by the emulator `Generator` using `subprocess.Popen`. Captures and logs stdout/stderr.

---

## üß® 8. `callExternalScripts()` Function

Executes executable scripts in given folders recursively, for `gameStart` and `gameStop` events.

---

## üéÆ 9. CLI Arguments via `argparse`

Supports rich CLI options including:

- Up to 8 player input configurations
- `-system`, `-rom`, `-core`, `-emulator`
- Netplay: `-netplaymode`, `-netplayip`, `-netplayport`, etc.
- Autosave/state handling
- HUD: `-systemname`, `-gameinfoxml`
- Lightgun & Wheel: `-lightgun`, `-wheel`

---
