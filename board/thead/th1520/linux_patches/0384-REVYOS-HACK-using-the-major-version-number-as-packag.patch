From a353bb0b6d43ec639370c365c11f2eb4ebb82127 Mon Sep 17 00:00:00 2001
From: Han Gao <rabenda.cn@gmail.com>
Date: Thu, 5 Jun 2025 00:54:56 +0800
Subject: [PATCH 384/400] REVYOS: HACK: using the major version number as
 package name

Signed-off-by: Han Gao <rabenda.cn@gmail.com>
---
 scripts/package/mkdebian | 27 ++++++++++++++++++++++++---
 1 file changed, 24 insertions(+), 3 deletions(-)

diff --git a/scripts/package/mkdebian b/scripts/package/mkdebian
index 420c1e4c2d40..d545cc01af21 100755
--- a/scripts/package/mkdebian
+++ b/scripts/package/mkdebian
@@ -179,6 +179,27 @@ echo $debarch > debian/arch
 extra_build_depends=", $(if_enabled_echo CONFIG_UNWINDER_ORC libelf-dev:native)"
 extra_build_depends="$extra_build_depends, $(if_enabled_echo CONFIG_SYSTEM_TRUSTED_KEYRING libssl-dev:native)"
 
+# A.B.CDE -> A.BE
+# 1. Extract the A.B part
+# Uses sed with extended regex (POSIX standard)Add commentMore actions
+PARSED_AB=$(echo "${KERNELRELEASE}" | sed -E 's/^([0-9]+\.[0-9]+)\..*$/\1/')
+
+# 2. Extract the E part
+# This sed chain removes A.B.C and optional -rcX parts,
+# leaving only the 'E' portion (which might be empty or start with a hyphen).
+E_PART=$(echo "${KERNELRELEASE}" | sed -E '
+    s/^[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+)?(.*)$/\2/;
+    /^-rc[0-9]+$/d; # If only "-rcX" remains, delete it (meaning E is empty)
+')
+
+# 3. Combine A.B and E
+# Check if E_PART is not empty. If it's not, append it to A.B.
+if [ -n "${E_PART}" ]; then
+    PACKAGENAMEVERSION="${PARSED_AB}${E_PART}"
+else
+    PACKAGENAMEVERSION="${PARSED_AB}"
+fi
+
 # Generate a simple changelog template
 cat <<EOF > debian/changelog
 $sourcename ($packageversion) $distribution; urgency=low
@@ -218,7 +239,7 @@ Rules-Requires-Root: no
 Build-Depends: bc, debhelper, rsync, kmod, cpio, bison, flex $extra_build_depends
 Homepage: https://www.kernel.org/
 
-Package: $packagename-$version
+Package: $packagename-${PACKAGENAMEVERSION}
 Architecture: $debarch
 Provides: wireguard-modules (= 1.0.0)
 Description: Linux kernel, version $version
@@ -242,7 +263,7 @@ EOF
 if is_enabled CONFIG_MODULES; then
 cat <<EOF >> debian/control
 
-Package: linux-headers-$version
+Package: linux-headers-${PACKAGENAMEVERSION}
 Architecture: $debarch
 Description: Linux kernel headers for $version on $debarch
  This package provides kernel header files for $version on $debarch
@@ -255,7 +276,7 @@ fi
 if is_enabled CONFIG_DEBUG_INFO; then
 cat <<EOF >> debian/control
 
-Package: linux-image-$version-dbg
+Package: linux-image-${PACKAGENAMEVERSION}-dbg
 Section: debug
 Architecture: $debarch
 Description: Linux kernel debugging symbols for $version
-- 
2.43.0

