From 854ddc65f1fa5fe488878065337e0f11920e142e Mon Sep 17 00:00:00 2001
From: Martin Blumenstingl <martin.blumenstingl@googlemail.com>
Date: Sun, 18 Feb 2024 18:14:39 +0100
Subject: [PATCH 88/95] WiP: Enable the ARM Global Timer

Signed-off-by: Martin Blumenstingl <martin.blumenstingl@googlemail.com>
---
 arch/arm/boot/dts/amlogic/meson8.dtsi  | 15 ++++++++++++---
 arch/arm/boot/dts/amlogic/meson8b.dtsi | 15 ++++++++++++---
 drivers/clocksource/arm_global_timer.c | 22 ++++++++++++++++------
 3 files changed, 40 insertions(+), 12 deletions(-)

diff --git a/arch/arm/boot/dts/amlogic/meson8.dtsi b/arch/arm/boot/dts/amlogic/meson8.dtsi
index 611431cf79c0..36bd5b14c919 100644
--- a/arch/arm/boot/dts/amlogic/meson8.dtsi
+++ b/arch/arm/boot/dts/amlogic/meson8.dtsi
@@ -931,10 +931,19 @@ timer@200 {
 		clocks = <&clkc CLKID_PERIPH>;
 
 		/*
-		 * the arm_global_timer driver currently does not handle clock
-		 * rate changes. Keep it disabled for now.
+		 * The ARM Global Timer can only change the prescaler at
+		 * runtime, which means that we need to find a pre-divider
+		 * which works together with the prescaler and can match
+		 * any CPU clock rate (from the slowest at 24MHz to the
+		 * highest at 1992MHz).
+		 * A pre-divider of 8 is a good compromise because it allows
+		 * running the ARM Global Timer at 3MHz which can be evenly
+		 * divided by all supported CPU frequencies from 24MHz to
+		 * 1992MHz while not overflowing the 8-bit prescaler in the
+		 * timer.
 		 */
-		status = "disabled";
+		assigned-clocks = <&clkc CLKID_PERIPH_SEL>;
+		assigned-clock-parents = <&clkc CLKID_CPU_CLK_DIV8>;
 	};
 
 	timer@600 {
diff --git a/arch/arm/boot/dts/amlogic/meson8b.dtsi b/arch/arm/boot/dts/amlogic/meson8b.dtsi
index 52a12c46bb62..b45c682a73d1 100644
--- a/arch/arm/boot/dts/amlogic/meson8b.dtsi
+++ b/arch/arm/boot/dts/amlogic/meson8b.dtsi
@@ -832,10 +832,19 @@ timer@200 {
 		clocks = <&clkc CLKID_PERIPH>;
 
 		/*
-		 * the arm_global_timer driver currently does not handle clock
-		 * rate changes. Keep it disabled for now.
+		 * The ARM Global Timer can only change the prescaler at
+		 * runtime, which means that we need to find a pre-divider
+		 * which works together with the prescaler and can match
+		 * any CPU clock rate (from the slowest at 24MHz to the
+		 * highest at 1992MHz).
+		 * A pre-divider of 8 is a good compromise because it allows
+		 * running the ARM Global Timer at 3MHz which can be evenly
+		 * divided by all supported CPU frequencies from 24MHz to
+		 * 1992MHz while not overflowing the 8-bit prescaler in the
+		 * timer.
 		 */
-		status = "disabled";
+		assigned-clocks = <&clkc CLKID_PERIPH_SEL>;
+		assigned-clock-parents = <&clkc CLKID_CPU_CLK_DIV8>;
 	};
 
 	timer@600 {
diff --git a/drivers/clocksource/arm_global_timer.c b/drivers/clocksource/arm_global_timer.c
index c7b6d78cbd8d..f4c647259a3a 100644
--- a/drivers/clocksource/arm_global_timer.c
+++ b/drivers/clocksource/arm_global_timer.c
@@ -268,10 +268,8 @@ static int __init gt_clocksource_init(void)
 	writel(0, gt_base + GT_CONTROL);
 	writel(0, gt_base + GT_COUNTER0);
 	writel(0, gt_base + GT_COUNTER1);
-	/* set prescaler and enable timer on all the cores */
-	writel(FIELD_PREP(GT_CONTROL_PRESCALER_MASK,
-			  CONFIG_ARM_GT_INITIAL_PRESCALER_VAL - 1) |
-	       GT_CONTROL_TIMER_ENABLE, gt_base + GT_CONTROL);
+	/* enable the timer on all the cores */
+	writel(GT_CONTROL_TIMER_ENABLE, gt_base + GT_CONTROL);
 
 #ifdef CONFIG_CLKSRC_ARM_GLOBAL_TIMER_SCHED_CLOCK
 	sched_clock_register(gt_sched_clock_read, 64, gt_target_rate);
@@ -341,7 +339,8 @@ static int gt_clk_rate_change_cb(struct notifier_block *nb,
 static int __init global_timer_of_register(struct device_node *np)
 {
 	struct clk *gt_clk;
-	static unsigned long gt_clk_rate;
+	unsigned long gt_clk_rate;
+	u32 prescaler;
 	int err;
 
 	/*
@@ -379,7 +378,17 @@ static int __init global_timer_of_register(struct device_node *np)
 	}
 
 	gt_clk_rate = clk_get_rate(gt_clk);
-	gt_target_rate = gt_clk_rate / CONFIG_ARM_GT_INITIAL_PRESCALER_VAL;
+
+	if (of_machine_is_compatible("amlogic,meson8") ||
+	    of_machine_is_compatible("amlogic,meson8b") ||
+	    of_machine_is_compatible("amlogic,meson8m2")) {
+		gt_target_rate = 3 * 1000 * 1000;
+		prescaler = gt_clk_rate / gt_target_rate;
+	} else {
+		prescaler = CONFIG_ARM_GT_INITIAL_PRESCALER_VAL;
+		gt_target_rate = gt_clk_rate / prescaler;
+	}
+
 	gt_clk_rate_change_nb.notifier_call =
 		gt_clk_rate_change_cb;
 	err = clk_notifier_register(gt_clk, &gt_clk_rate_change_nb);
@@ -404,6 +413,7 @@ static int __init global_timer_of_register(struct device_node *np)
 	}
 
 	/* Register and immediately configure the timer on the boot CPU */
+	gt_write_presc(prescaler - 1);
 	err = gt_clocksource_init();
 	if (err)
 		goto out_irq;
-- 
2.43.0

